<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login & Signup</title>
    <link rel="icon" href="../../PBL4_imgs/icon/logo.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background:url(../../PBL4_imgs/image/background5.png);
            background-size: cover;
            font-family: Arial, sans-serif;
        }

        .container {
            position: relative;
            width: 1100px;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex;
            transition: transform 0.8s ease-in-out;
        }

        .left, .right {
            flex: 1; /* Chia ƒë·ªÅu 50% - 50% */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
            transition: transform 0.8s ease-in-out;
        }

        .left {
            background: url("../../PBL4_imgs/image/background.jpg") no-repeat center center;
            background-size: cover;
            color: white;
        }

        .right {
            background: rgba(0,0,0,0.85);
            color: white;
        }

        /* Logo ·ªü gi·ªØa */
        .logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 50%;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 30;
        }
        .logo img {
            width: 80px;
            height: 80px;
            display: block;
        }

        .password-wrapper {
            position: relative;
            width: 100%;
        }
        .password-wrapper input {
            width: 100%;
            padding-right: 40px !important;
            box-sizing: border-box;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #333; /* M√†u c·ªßa con m·∫Øt */
            user-select: none; /* Kh√¥ng cho ph√©p b√¥i ƒëen */
        }
        .title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .form {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form input {
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-login { background: #0789fb; }
        .btn-login:hover { background: #64a1e8; }
        .btn-register { background: #0788fb; }
        .btn-register:hover { background: #64a1e8; }

        .btn-google { background: #f44336; }
        .btn-google:hover { background: #c62828; }

        /* --- TH√äM M·ªöI CSS CHO N√öT GUEST --- */
        .btn-guest { background: #6c757d; }
        .btn-guest:hover { background: #5a6268; }

        .btn-google img {
            width: 20px;
            height: 20px;
        }

        .link {
            margin-top: 15px;
            font-size: 14px;
            cursor: pointer;
            color: #bbb;
        }
        .link:hover { color: white; text-decoration: underline; }

        /* Khi b·∫≠t Signup mode */
        .container.show-signup .left {
            transform: translateX(100%);
        }
        .container.show-signup .right {
            transform: translateX(-100%);
        }
        input[type="password"]::-ms-reveal {
            display: none;
        }
    </style>
</head>
<body>
<div class="container" id="container">
    <div class="left"></div>
    <div class="logo">
        <img src="../../PBL4_imgs/icon/logo.png" alt="Logo">
    </div>
    <div class="right" id="form-box">
        <div class="title" id="form-title">Log In</div>
        <div class="form" id="form-content">
        </div>
        <div class="link" onclick="toggleForm()">Don‚Äôt have an account? Sign Up</div>
    </div>
</div>

<script>
    const container = document.getElementById("container");
    const formTitle = document.getElementById("form-title");
    const formContent = document.getElementById("form-content");
    const link = document.querySelector(".link");

    let isSignup = false;
    const API_URL = "http://localhost:8910";

    // --- TH√äM M·ªöI: H√ÄM X·ª¨ L√ù CH∆†I V·ªöI T∆Ø C√ÅCH GUEST ---
    function playAsGuest() {
        // L·∫•y m·ªôt t√™n Guest ng·∫´u nhi√™n ƒë·ªÉ server c√≥ th·ªÉ nh·∫≠n di·ªán
        const randomId = Math.floor(Math.random() * 1000);
        localStorage.removeItem("playerId");
        localStorage.removeItem("playerName");
        localStorage.removeItem("token");
        // X√≥a playerId c≈© (n·∫øu c√≥) ƒë·ªÉ server bi·∫øt ƒë√¢y l√† guest m·ªõi
        window.location.href = "Home_page.html";

        // Chuy·ªÉn trang (Gi·∫£ s·ª≠ Home_page.html c√πng c·∫•p v·ªõi MainLogin.html)
        // **QUAN TR·ªåNG**: ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y ƒë√∫ng v·ªõi c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa b·∫°n
    }

    // H√ÄM M·ªöI: Chuy·ªÉn ƒë·∫øn trang Google Login
    function redirectToGoogleLogin() {
        // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i (login ho·∫∑c signup) ƒë·ªÉ trang Google bi·∫øt
        localStorage.setItem("googleAuthMode", isSignup ? "signup" : "login");

        // Chuy·ªÉn ƒë·∫øn trang Google Login
        // **QUAN TR·ªåNG**: Thay ƒë·ªïi ƒë∆∞·ªùng d·∫´n n√†y cho ph√π h·ª£p v·ªõi c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa b·∫°n
        window.location.href = "ggAccount.html";
    }

    formContent.addEventListener('click', async function(event) {

        // S·ª¨A L·ªñI 1: L·∫•y ƒë√∫ng target
        const target = event.target;

        // --- CHECK 1: Click v√†o "con m·∫Øt" ? ---
        if (target.classList.contains('toggle-password')) {
            // KH√îNG d√πng preventDefault() ·ªü ƒë√¢y
            const input = target.previousElementSibling; // L·∫•y <input> ngay tr∆∞·ªõc <span>

            if (input && input.type === "password") {
                input.type = "text";
                target.textContent = "üôà"; // ƒê·ªïi icon
            } else if (input && input.type === "text") {
                input.type = "password";
                target.textContent = "üôâÔ∏è"; // ƒê·ªïi l·∫°i
            }
            return; // X·ª≠ l√Ω xong, tho√°t
        }

        // --- CHECK 2: Click v√†o <button> ? ---
        const buttonTarget = target.closest('button');
        if (!buttonTarget) {
            // N·∫øu click v√†o input ho·∫∑c kho·∫£ng tr·∫Øng, kh√¥ng l√†m g√¨ c·∫£
            return;
        }

        // S·ª¨A L·ªñI 2: Di chuy·ªÉn preventDefault() xu·ªëng ƒë√¢y
        // Ch·ªâ ngƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh C·ª¶A N√öT
        event.preventDefault();

        // S·ª¨A L·ªñI 3: L·∫•y input ·ªü ƒë√¢y ƒë·ªÉ c·∫£ Login v√† Register ƒë·ªÅu d√πng ƒë∆∞·ª£c
        const usernameInput = formContent.querySelector('input[placeholder="Username"]');
        const passwordInput = formContent.querySelector('input[placeholder="Password"]');

        // X·ª≠ l√Ω c√°c n√∫t
        if (buttonTarget.classList.contains('btn-login')) {
            if(!passwordInput.value || !usernameInput.value){
                alert("Please enter full information!");
                return;
            }
            const respone = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: usernameInput.value, password: passwordInput.value}),
            });

            const result = await respone.json();

            if(respone.ok) {
                if (result.success) {
                    localStorage.setItem("token", result.data.token);

                    // L∆∞u TO√ÄN B·ªò th√¥ng tin user d·∫°ng JSON
                    const userData = {
                        userId: result.data.userId,
                        username: result.data.username,
                        email: result.data.email,
                        avatar: result.data.avatar || '../../PBL4_imgs/icon/man.png',
                        elo: result.data.elo || 1200,
                        winCount: result.data.winCount || 0,
                        lossCount: result.data.lossCount || 0,
                        createdAt: result.data.createdAt || new Date().toISOString()
                    };

                    // Chuy·ªÉn object th√†nh JSON string v√† l∆∞u
                    // L∆ØU ƒê√öNG 100% ‚Äì KH√îNG TH·ªÇ SAI ƒê∆Ø·ª¢C N·ªÆA
                    localStorage.setItem("token", result.data.token);
                    localStorage.setItem("playerId", result.data.userId);
                    localStorage.setItem("playerName", result.data.username);           // ƒê√öNG KEY
                    localStorage.setItem("avatarUrl", result.data.avatar || "../../PBL4_imgs/icon/man.png");

                    // Cache th√™m cache ƒë·ªÉ l·∫ßn sau load nhanh (t√πy ch·ªçn nh∆∞ng t·ªët)
                    localStorage.setItem("userData", JSON.stringify({
                        playerId: result.data.userId,
                        username: result.data.username,
                        avatarUrl: result.data.avatar || "../../PBL4_imgs/icon/man.png"
                    }));

                    window.location.href = "Home_page.html";             }
                else {
                    alert(result.error);
                }
            }
            else {
                alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + result.error);
            }
        }
        // X·ª¨ L√ù N√öT GOOGLE - THAY ƒê·ªîI
        if (buttonTarget.classList.contains('btn-google')) {
            redirectToGoogleLogin();
            return;
        }
        else if (buttonTarget.classList.contains('btn-guest')) {
            playAsGuest();
        }
        else if (buttonTarget.classList.contains('btn-register')) {
            const ConfirmPasswordInput = formContent.querySelector('input[placeholder="Confirm Password"]');
            if(passwordInput.value !== ConfirmPasswordInput.value){
                alert("ConfirmPassWord is not match");
                return;
            }
            if(!passwordInput.value || !usernameInput.value || !ConfirmPasswordInput.value){
                alert("Please enter full information!");
                return;
            }
            if(passwordInput.value.length < 6){
                alert("Password must be at least 6 characters");
                return;
            }

            // S·ª¨A L·ªñI 4: Th√™m logic cho n√∫t ƒêƒÉng k√Ω
            const respone = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: usernameInput.value, password: passwordInput.value}),
            });

            const result = await respone.json();

            if (respone.ok) {
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                toggleForm(); // L·∫≠t v·ªÅ trang ƒëƒÉng nh·∫≠p
            } else {
                alert("ƒêƒÉng k√Ω th·∫•t b·∫°i: " + result.error);
            }
        }
    });

    // S·ª≠a ƒë·ªïi h√†m toggleForm ƒë·ªÉ ch√®n HTML
    function toggleForm() {
        isSignup = !isSignup;
        container.classList.toggle("show-signup");

        if (isSignup) {
            formTitle.textContent = "Sign Up";
            formContent.innerHTML = `
<!--          <input type="text" placeholder="Full Name">-->
<!--          <input type="email" placeholder="Email">-->
          <input type="text" placeholder="Username">
          <div class="password-wrapper">
            <input type="password" placeholder="Password">
            <span class="toggle-password">üôâÔ∏è</span>
          </div>
        <div class="password-wrapper">
          <input type="password" placeholder="Confirm Password">
          <span class="toggle-password">üôâ</span>
      </div>
          <button class="btn btn-register">Sign Up</button>
          <button class="btn btn-google">
            <img src="../../PBL4_imgs/image/google.png" alt="Google Logo">
            Sign Up With Google
          </button>
          <button class="btn btn-guest">Play as Guest</button> `;
            link.textContent = "Already have an account? Log In";
        } else {
            formTitle.textContent = "Log In";
            formContent.innerHTML = `
          <input name = "username" type="text" placeholder="Username">
            <div class="password-wrapper">
                <input name = "password" type="password" placeholder="Password">
                <span class="toggle-password">üôâ</span>
            </div>
          <button class="btn btn-login">Log In</button>
          <button class="btn btn-google">
            <img src="../../PBL4_imgs/image/google.png" alt="Google Logo">
            Log In With Google
          </button>
          <button class="btn btn-guest">Play as Guest</button> `;
            link.textContent = "Don't have an account? Sign Up";
        }
    }

    // --- TH√äM M·ªöI: G·ªçi toggleForm l·∫ßn ƒë·∫ßu ƒë·ªÉ hi·ªÉn th·ªã form login m·∫∑c ƒë·ªãnh ---
    toggleForm(); // Hi·ªÉn th·ªã form
    toggleForm(); // G·ªçi l·∫°i ƒë·ªÉ quay v·ªÅ tr·∫°ng th√°i login ban ƒë·∫ßu (h∆°i hacky nh∆∞ng ho·∫°t ƒë·ªông)

</script>
</body>
</html>
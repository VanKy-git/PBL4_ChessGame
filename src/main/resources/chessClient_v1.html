<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Online Chess</title>
    <style>
        :root{
            --size: 64px;
            --board-gap: 8px;
        }
        body{
            font-family: system-ui, Arial;
            display:flex;
            gap:24px;
            padding:24px;
            background-image: url(../resources/background5.png);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .wrapper{display:flex;flex-direction:column;align-items:center}
        .board{
            display:grid;
            grid-template-columns: repeat(8, var(--size));
            grid-template-rows: repeat(8, var(--size));
            gap:0;
            border: 4px solid #333;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            user-select:none;
        }
        .square{
            width:var(--size); height:var(--size);
            display:flex;align-items:center;justify-content:center;
            font-size:32px; cursor:pointer; position:relative;
        }
        .square.light{ background: #f0d9b5; }
        .square.dark{ background: #b58863; }
        .square.highlight{ outline: 4px solid rgba(50,180,50,0.6); box-sizing:border-box; }
        .coords{font-size:12px; position:absolute; bottom:2px; right:4px; color:rgba(0,0,0,0.35)}
        .info{
            width:320px;
            background:white;
            padding:20px;
            border-radius:8px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1)
        }
        .status{
            font-weight:600;
            margin-bottom:12px;
            padding:8px;
            background:#e8f4fd;
            border-radius:4px;
            text-align:center
        }
        .connection-status{
            font-size:14px;
            margin-bottom:8px;
            padding:6px;
            border-radius:4px;
            text-align:center
        }
        .connected{background:#d4edda; color:#155724}
        .disconnected{background:#f8d7da; color:#721c24}
        .game-info{margin:12px 0; font-size:14px}
        .game-info div{margin:4px 0}
        #playerName{
            margin-bottom:8px;
            padding:8px;
            border:1px solid #ddd;
            border-radius:4px;
            width:100%;
            box-sizing: border-box;
        }
        button{
            margin:4px 0;
            padding:8px 12px;
            border-radius:4px;
            border:1px solid #007bff;
            background:#007bff;
            color:white;
            cursor:pointer;
            width:100%;
            box-sizing: border-box;
        }
        button:hover{background:#0056b3}
        button:disabled{background:#6c757d; cursor:not-allowed}
        #roomControls input {
            margin-top: 4px;
            padding: 6px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #leaveRoomBtn { background: #dc3545; border: none; }
        #leaveRoomBtn:hover { background: #a91f30; }
        .chat-box {
            margin-top: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            height: 180px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            font-size: 14px;
            background: #fafafa;
        }
        .chat-input { display: flex; border-top: 1px solid #ccc; }
        .chat-input input { flex: 1; padding: 6px; border: none; outline: none; }
        .chat-input button { width: auto; border: none; padding: 6px 10px; }
        #winMessage {
            display:none; padding:12px; background:#d4edda;
            color:#155724; font-weight:bold; text-align:center;
            border-radius:6px; margin-top:10px;
        }
        #promotionPopup .promo-option {
            font-size: 48px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }
        #promotionPopup .promo-option:hover {
            background: #eee;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="board" class="board" aria-label="Chess board"></div>
</div>

<div class="info">
    <div id="connectionStatus" class="connection-status disconnected">Ch∆∞a k·∫øt n·ªëi</div>
    <div id="loginSection">
        <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" value="Player1">
        <button id="connectBtn">K·∫øt n·ªëi</button>
    </div>
    <div id="gameSection" style="display:none">
        <div class="status" id="status">ƒêang ch·ªù...</div>
        <div class="game-info">
            <div><strong>Ph√≤ng:</strong> <span id="roomInfo">-</span></div>
            <div><strong>M√†u qu√¢n:</strong> <span id="colorInfo">-</span></div>
            <div><strong>ID:</strong> <span id="playerIdInfo">-</span></div>
        </div>
        <div id="roomControls">
            <button id="createRoomBtn">T·∫°o ph√≤ng</button>
            <input type="text" id="joinRoomId" placeholder="Nh·∫≠p ID ph√≤ng">
            <button id="joinRoomBtn">Tham gia ph√≤ng</button>
            <button id="leaveRoomBtn" style="display:none;">R·ªùi ph√≤ng</button>
        </div>
        <div id="chatSection" style="display:none;">
            <div class="chat-box">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input">
                    <input id="chatInput" type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
                    <button id="chatSendBtn">G·ª≠i</button>
                </div>
            </div>
        </div>
        <div id="winMessage">üéâ B·∫°n ƒë√£ th·∫Øng tr·∫≠n ƒë·∫•u!</div>
        <button id="newGameBtn">T√¨m tr·∫≠n m·ªõi</button>
    </div>
</div>

<script>
    // Constants
    const PIECES = {
        'r':'\u265C','n':'\u265E','b':'\u265D','q':'\u265B','k':'\u265A','p':'\u265F',
        'R':'\u2656','N':'\u2658','B':'\u2657','Q':'\u2655','K':'\u2654','P':'\u2659'
    };
    const STARTING_FEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";

    // Game state variables
    let websocket = null;
    let playerId = null;
    let playerName = null;
    let yourColor = null;
    let roomId = null;
    let gameActive = false;
    let alreadyFlipped = false;
    let currentTurn = 'white';
    let clientBoard = []; // 2D array representation of the board, updated by renderFromFen
    let selected = null; // {r, c} of the selected piece
    let flipped = false;

    // UI Elements
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const loginSectionEl = document.getElementById('loginSection');
    const gameSectionEl = document.getElementById('gameSection');
    const playerNameInput = document.getElementById('playerName');
    const connectBtn = document.getElementById('connectBtn');
    const newGameBtn = document.getElementById('newGameBtn');
    const roomInfoEl = document.getElementById('roomInfo');
    const colorInfoEl = document.getElementById('colorInfo');
    const playerIdInfoEl = document.getElementById('playerIdInfo');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const joinRoomIdInput = document.getElementById('joinRoomId');
    const leaveRoomBtn = document.getElementById('leaveRoomBtn');
    const chatSection = document.getElementById('chatSection');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const winMessage = document.getElementById('winMessage');

    // ================== WebSocket and Message Handling ==================

    function connect() {
        const name = playerNameInput.value.trim();
        if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n!'); return; }
        playerName = name;
        const url = "ws://localhost:8080";
        try {
            websocket = new WebSocket(url);
            websocket.onopen = () => {
                updateConnectionStatus(true);
                websocket.send(JSON.stringify({ type: "connect", playerName: playerName }));
            };
            websocket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log('Received:', msg);
                handleMessage(msg);
            };
            websocket.onclose = () => {
                updateConnectionStatus(false);
                resetGameState();
            };
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        } catch (error) {
            console.error('Connection error:', error);
            alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server!');
        }
    }

    function handleMessage(msg) {
        switch (msg.type) {
            case 'player_info':
                playerId = msg.playerId;
                playerIdInfoEl.textContent = playerId;
                loginSectionEl.style.display = 'none';
                gameSectionEl.style.display = 'block';
                statusEl.textContent = 'ƒêang s·∫µn s√†ng...';
                break;

            case 'room_info':
                roomId = msg.roomId;
                roomInfoEl.textContent = roomId;
                break;

            case 'room_created':
                roomId = msg.roomId;
                yourColor = msg.color;
                roomInfoEl.textContent = roomId;
                colorInfoEl.textContent = yourColor;
                flipBoardIfNeeded();
                showChatAndLeave();
                break;

            case 'room_joined':
                roomId = msg.roomId;
                yourColor = msg.color;
                roomInfoEl.textContent = roomId;
                colorInfoEl.textContent = yourColor;
                flipBoardIfNeeded();
                showChatAndLeave();
                renderFromFen(msg.gameState || STARTING_FEN); // Use gameState if provided
                break;

            case 'color':
                yourColor = msg.color;
                colorInfoEl.textContent = msg.color === 'white' ? 'Tr·∫Øng (ƒëi tr∆∞·ªõc)' : 'ƒêen (ƒëi sau)';
                flipBoardIfNeeded();
                break;

            case 'game_start':
                gameActive = true;
                newGameBtn.style.display = 'none';
                currentTurn = msg.currentTurn || 'white';
                updateStatus();
                renderFromFen(STARTING_FEN);
                showChatAndLeave();
                break;

            case 'turn_change':
                currentTurn = msg.currentTurn;
                updateStatus();
                break;

            case 'chat':
                addChatMessage(msg.playerName || "Ng∆∞·ªùi ch∆°i", msg.message);
                break;

            case 'player_left':
            case 'player_disconnected':
                alert('ƒê·ªëi th·ªß ƒë√£ r·ªùi kh·ªèi game!');
                resetGameState();
                break;

            case 'move_result':
                if (msg.result === true) {
                    renderFromFen(msg.fen);
                } else {
                    alert(msg.message);
                }
                break;

            case 'end_game':
                gameActive = false;
                winMessage.textContent = `üéâ ${msg.winner} th·∫Øng!`;
                winMessage.style.display = "block";
                break;

            case 'error':
                alert('L·ªói: ' + msg.message);
                break;

            default:
                console.log('Unknown message type:', msg.type);
        }
    }

    // ================== Rendering and Board Logic ==================

    function renderFromFen(fen) {
        // Update the client's internal board representation
        clientBoard = Array(8).fill(null).map(() => Array(8).fill(null));
        const [piecePlacement] = fen.split(" ");
        const rows = piecePlacement.split('/');
        for (let r = 0; r < rows.length; r++) {
            const row = rows[r];
            let c = 0;
            for (const char of row) {
                if (isNaN(char)) {
                    clientBoard[r][c] = char;
                    c++;
                } else {
                    c += parseInt(char);
                }
            }
        }

        // Render the board HTML
        boardEl.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const rr = flipped ? 7 - r : r;
                const cc = flipped ? 7 - c : c;
                const square = document.createElement('div');
                square.className = 'square ' + (((r + c) % 2 === 0) ? 'light' : 'dark');
                square.dataset.r = rr;
                square.dataset.c = cc;
                square.dataset.alg = coordToAlg(rr, cc);
                square.addEventListener('click', onSquareClick);

                const piece = clientBoard[rr][cc];
                if (piece) {
                    const span = document.createElement('span');
                    span.textContent = PIECES[piece] || '?';
                    span.dataset.piece = piece;
                    square.appendChild(span);
                }

                const coord = document.createElement('div');
                coord.className = 'coords';
                coord.textContent = square.dataset.alg;
                square.appendChild(coord);
                boardEl.appendChild(square);
            }
        }
    }

    function onSquareClick(e) {
        if (!gameActive || currentTurn !== yourColor) return;
        const squareEl = e.currentTarget;
        const r = parseInt(squareEl.dataset.r);
        const c = parseInt(squareEl.dataset.c);
        const piece = clientBoard[r][c];

        if (selected) { // A piece was already selected
            // Deselect if clicking the same square
            if (selected.r === r && selected.c === c) {
                selected = null;
                squareEl.classList.remove('highlight');
                return;
            }

            // Send move request to server
            websocket.send(JSON.stringify({
                type: 'move_request',
                from: coordToAlg(selected.r, selected.c),
                to: coordToAlg(r, c),
                roomId: roomId
            }));

            // Clear selection
            const previouslySelectedEl = document.querySelector(`[data-r="${selected.r}"][data-c="${selected.c}"]`);
            if (previouslySelectedEl) previouslySelectedEl.classList.remove('highlight');
            selected = null;

        } else { // No piece is selected yet
            if (piece && isPieceOurColor(piece)) {
                selected = { r, c };
                squareEl.classList.add('highlight');
            }
        }
    }

    // ================== UI and State Management ==================

    function updateStatus() {
        if (!gameActive) { statusEl.textContent = 'Ch∆∞a c√≥ game'; return; }
        const turnText = currentTurn === 'white' ? 'Tr·∫Øng' : 'ƒêen';
        const isMyTurn = currentTurn === yourColor;
        statusEl.textContent = `L∆∞·ª£t: ${turnText}${isMyTurn ? ' (B·∫°n)' : ' (ƒê·ªëi th·ªß)'}`;
        statusEl.style.backgroundColor = isMyTurn ? '#d4edda' : '#fff3cd';
    }

    function resetGameState() {
        gameActive = false;
        yourColor = null;
        roomId = null;
        currentTurn = 'white';
        selected = null;
        statusEl.textContent = 'ƒê√£ ng·∫Øt k·∫øt n·ªëi';
        winMessage.style.display = 'none';
        resetRoomUI();
        renderFromFen(STARTING_FEN);
    }

    function updateConnectionStatus(connected) {
        connectionStatusEl.textContent = connected ? 'ƒê√£ k·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi';
        connectionStatusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        connectBtn.disabled = connected;
    }

    function flipBoardIfNeeded() {
        const shouldBeFlipped = (yourColor === 'black');
        if (flipped !== shouldBeFlipped) {
            flipped = shouldBeFlipped;
            renderFromFen(STARTING_FEN); // Re-render after flipping
        }
    }

    function findNewGame() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            resetGameState();
            websocket.send(JSON.stringify({type: "join",playerName: playerName}));
            statusEl.textContent = 'ƒêang t√¨m ƒë·ªëi th·ªß...';
        }
    }

    // ================== Room and Chat UI ==================

    function showChatAndLeave() {
        chatSection.style.display = "block";
        leaveRoomBtn.style.display = "block";
        createRoomBtn.style.display = "none";
        joinRoomBtn.style.display = "none";
        joinRoomIdInput.style.display = "none";
        newGameBtn.style.display = "none";
    }

    function resetRoomUI() {
        roomId = null;
        roomInfoEl.textContent = "-";
        chatSection.style.display = "none";
        leaveRoomBtn.style.display = "none";
        createRoomBtn.style.display = "block";
        joinRoomBtn.style.display = "block";
        joinRoomIdInput.style.display = "block";
        newGameBtn.style.display = "block";
        chatMessages.innerHTML = "";
    }

    function addChatMessage(sender, text) {
        const div = document.createElement("div");
        div.textContent = `${sender}: ${text}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ================== Helper Functions ==================

    function coordToAlg(r, c) {
        return String.fromCharCode('a'.charCodeAt(0) + c) + (8 - r);
    }

    function isPieceOurColor(piece) {
        if (!yourColor || !piece || piece === '.') return false;
        const isWhitePiece = piece === piece.toUpperCase();
        return (yourColor === 'white' && isWhitePiece) || (yourColor === 'black' && !isWhitePiece);
    }

    // ================== Event Listeners ==================

    connectBtn.addEventListener('click', connect);
    newGameBtn.addEventListener('click', findNewGame);
    createRoomBtn.addEventListener('click', () => websocket.send(JSON.stringify({ type: "create_room" })));
    joinRoomBtn.addEventListener('click', () => {
        const id = joinRoomIdInput.value.trim();
        if(id) websocket.send(JSON.stringify({ type: "join_room", roomId: id }));
    });
    leaveRoomBtn.addEventListener('click', () => {
        if(roomId) websocket.send(JSON.stringify({ type: "leave_room", roomId: roomId }));
        resetRoomUI();
    });
    chatSendBtn.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if(!text || !roomId) return;
        websocket.send(JSON.stringify({ type: "chat", roomId: roomId, message: text }));
        chatInput.value = "";
    });
    playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') connect(); });
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') chatSendBtn.click(); });

    // ================== Pawn Promotion Logic ==================
    let pendingPromotion = null; // L∆∞u t·∫°m n∆∞·ªõc ƒëi c·∫ßn phong c·∫•p
    const promotionPopup = document.getElementById('promotionPopup');

    function showPromotionChoices(from, to) {
        pendingPromotion = { from, to };
        promotionPopup.style.display = "flex";
    }

    promotionPopup.addEventListener('click', (e) => {
        if (e.target.classList.contains('promo-option')) {
            const choice = e.target.dataset.piece;
            if (pendingPromotion) {
                websocket.send(JSON.stringify({
                    type: 'promotion_choice',
                    roomId: roomId,
                    from: pendingPromotion.from,
                    to: pendingPromotion.to,
                    promoteTo: choice
                }));
                pendingPromotion = null;
            }
            promotionPopup.style.display = "none";
        } else {
            // Click ra ngo√†i th√¨ h·ªßy ch·ªçn
            promotionPopup.style.display = "none";
            pendingPromotion = null;
        }
    });

    // Initial render on page load
    renderFromFen(STARTING_FEN);
</script>
<div id="promotionPopup" style="
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.6);
    align-items:center; justify-content:center;
    z-index:1000;">
    <div style="background:white; padding:16px; border-radius:8px; display:flex; gap:12px;">
        <div class="promo-option" data-piece="q">‚ôï</div>
        <div class="promo-option" data-piece="r">‚ôñ</div>
        <div class="promo-option" data-piece="b">‚ôó</div>
        <div class="promo-option" data-piece="n">‚ôò</div>
    </div>
</div>

</body>
</html>
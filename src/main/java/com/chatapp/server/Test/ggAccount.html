<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đăng nhập / Đăng ký bằng Google</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body {
          font-family: "Segoe UI", Arial, sans-serif;
          background: #f5f7fb;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          margin: 0;
        }
        .container {
          width: 400px;
          background: white;
          border-radius: 10px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.1);
          padding: 30px;
          text-align: center;
        }
        h2 {
          margin-bottom: 20px;
          color: #333;
        }
        button {
          width: 100%;
          padding: 10px;
          margin-top: 10px;
          font-size: 16px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          transition: 0.2s;
        }
        .login-btn { background: #4285F4; color: white; }
        .register-btn { background: #34A853; color: white; }
        button:hover { opacity: 0.9; }
        #status {
          margin-top: 20px;
          font-size: 14px;
          color: #555;
          text-align: left;
          white-space: pre-wrap;
          word-break: break-word;
          background: #f2f5ff;
          padding: 10px;
          border-radius: 6px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Đăng nhập / Đăng ký bằng Google</h2>

    // data-client-id: id của OAuth 2.0
    <div id="g_id_onload"
         data-client_id="660085540047-jc210st32m11fil9rp7n5lck025jfc67.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="signin_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <button class="register-btn" id="registerBtn">Đăng ký bằng Google</button>

    <div id="status">Chưa đăng nhập</div>
</div>

<script>
    // 🟢 URL API backend (theo userController)
    const LOGIN_API = "http://localhost:63342/user/loginWithGoogle";
    const REGISTER_API = "http://localhost:63342/user/registerWithGoogle";

    let latestToken = null; // lưu token từ Google

    // Hàm callback khi Google trả idToken
    function handleCredentialResponse(response) {
      latestToken = response.credential;
      document.getElementById('status').innerText =
        "✅ Đã nhận idToken từ Google. Giờ bạn có thể chọn Đăng nhập hoặc Đăng ký.";
    }

    // Hàm chung gửi token tới server
    async function sendTokenToServer(apiUrl) {
      if (!latestToken) {
        alert("Bạn cần đăng nhập Google trước!");
        return;
      }

      document.getElementById('status').innerText = "🔄 Gửi token tới server...";

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken: latestToken })
        });

        const text = await res.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          throw new Error("Server trả về HTML hoặc sai định dạng:\n" + text);
        }

        if (result.success) {
          document.getElementById('status').innerText =
            "✅ Thành công!\nNgười dùng: " + result.data.name + "\nEmail: " + result.data.email;
        } else {
          document.getElementById('status').innerText =
            "⚠️ Lỗi: " + (result.message || "Không xác định");
        }

      } catch (err) {
        document.getElementById('status').innerText =
          "❌ Lỗi kết nối server: " + err.message;
      }
    }

    // Gán sự kiện cho nút
    document.getElementById("registerBtn").addEventListener("click", () => {
      sendTokenToServer(REGISTER_API);
    });
</script>
</body>
</html>
